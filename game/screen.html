<head>
<script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.6.0.js"></script>
  <link rel="stylesheet" href="screen.css">
  <link rel="stylesheet" href="shared.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>
<body>

<div id="screen-wrapper">
	<div>Guess the song that is currently playing!</div>
	<div class="debug" id="current_artist"></div>
	<div class="debug" id="current_title"></div>
	<div class="debug" id="current_album"></div>
	<div class="debug" id="current_year"></div>
	<div class="debug" id="current_album_art"></div>
	
</div>


    <script type="text/javascript">
    var air_console = new AirConsole();
	
	// whether or not to display all information
	var debug = false;
	
	// variable to store the library in after an initial query
	var library;
	
	// initially hide the debug section (unless var is set to true)
	if ( debug === false ){
		$(".debug").hide();
	}
	
	// get list of songs, choose one at random
	$.ajax(
		{ method: "POST", url: "ajax.php", data: {} , dataType: "json" })
		.done(function( msg ) {
			library = msg;
			
			play_random_song();
		});
	
	// stores the current solution
	document.solution = [];
	
	function play_random_song(){
		randomSong = Math.floor(Math.random() * library.length) + 1;
		// manual debug override
		// randomSong = 552;
		console.log("playing song " + randomSong + " in library");
		console.log( library[randomSong] );
		$.ajax(
		{ method: "POST", url: "ajax.php", data: { track_id: library[randomSong].nid } , dataType: "json" })
			.done(function( msg ) {
			// remove previous player
			$("#player").remove();
			
			player = '<audio id="player" autoplay="true"> <source src="/game/proxy.php?hash=' +  msg + '" type="audio/mpeg"></audio>';
			
			$("body").append(player);
				
			// turn volume down
			$("#player").prop("volume", 0.1);
			
			$("#current_artist").html(library[randomSong].artist);
			$("#current_title").html(library[randomSong].title);
			$("#current_album").html(library[randomSong].album);
			$("#current_year").html(library[randomSong].year);
			$("#current_album_art").html('<img src="' + library[randomSong].albumArtRef[0].url + '" />');
			
			document.solution = [];
			document.solution.push({ type: "solution", artist: library[randomSong].artist.replace(/ /g,'').toUpperCase(), title: library[randomSong].title.replace(/ /g,'').toUpperCase() });
			// send the solution to all clients
			air_console.broadcast( document.solution );
			
		});
	}
	
    // Listen for messages from other devices
    air_console.onMessage = function(from, message) {
		// handle message
		var type = message[0].type;
		console.log('handling ' + type + ' message.');
		if( type === 'nextSong'){
			// reset guess areas
			$(".resetme").each(function(){
				$(this).html("");
			});
			play_random_song();
		} else if ( type === 'debug' ){
			if( debug ){
				// turn it off
				debug = false;
				$(".debug").hide();
			} else {
				// turn it on
				debug = true;
				$(".debug").show();
			}
		} else if ( type === 'correctGuess' ){
			var finished_title = false;
			var finished_artist = false;
			
			console.log("Player " + from + " guessed a letter!");
			// check the length of the guess word versus the solution
			console.log(message[0].type_of_guess);
			if( message[0].type_of_guess === 'title' ){
				if( document.solution[0].title.length === message[0].progress ){
					// player finished the title!
					finished_title = true;
				}
			} else if ( message[0].type_of_guess === 'artist' ){
				if( document.solution[0].artist.length === message[0].progress ){
					// player finished the artist!
					finished_artist = true;
				}
			}

			// check if the player already has a guess area
			guessArea = false;
			$("#player_" + from).each(function(){
				guessArea = true;
			});
			if( ! guessArea ){
				// determine nickname of player
				nickname = air_console.getNickname( from );
				// add empty guessArea
				$("#screen-wrapper").append('<div class="playerGuesses left" id="player_' + from +'"><div class="left" id="player_' + from +'_label">' + nickname + ':</div><div class="left resetme" id="player_' + from +'_artist"></div><div class="resetme"> - </div><div class="left resetme" id="player_' + from +'_title"> </div></div>');
			}
			if( message[0].type_of_guess === 'title' ){
				$("#player_" + from + "_title").html(message[0].word);
			} else if ( message[0].type_of_guess === 'artist' ){
				$("#player_" + from + "_artist").html(message[0].word);
			}
			
			if( finished_title ){
				$("#player_" + from + "_title").css('color', 'green');
			} else {
				// reset color
				$("#player_" + from + "_title").css('color', 'black');
			}
			if( finished_artist ){
				$("#player_" + from + "_artist").css('color', 'green');
			} else {
				// reset color
				$("#player_" + from + "_artist").css('color', 'black');
			}
		}
    };
	
    </script>
	
</body>