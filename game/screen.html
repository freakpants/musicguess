<head>
<script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.6.0.js"></script>
  <link rel="stylesheet" href="screen.css">
  <link rel="stylesheet" href="shared.css">
  <link href="https://fonts.googleapis.com/css?family=Oswald|Roboto" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>
<body>
	

<div id="screen-wrapper">
	<div class="instruction">Welcome to MusicGuess. Select a playlist and press start to play!</div>
</div>
<div id="playlist-selector"></div>
<div id="roundTime"></div>
<div id="player-results"></div>

<script type="text/javascript">
var air_console = new AirConsole();

// whether or not to display all information
var debug = false;

// variable to store the library in after an initial query
var library;

// initially hide the debug section (unless var is set to true)
if ( debug === false ){
	$(".debug").hide();
}

// store amount of correct full guesses
document.amount_of_finished_players = 0;

document.round = 0;
document.RoundTime = 30;
document.maxRound = 10;

// store current scores of players
document.playerScores = [];

// stores the number of the selected playlist (not the id!!)
document.selectedPlaylist = 3;

$( document ).ready(function(){
	// get the playlists info
	$.ajax({ method: "GET", url: "/game/playlists/playlist_info.json", data: {} , dataType: "json" })
		.done(function( msg ) {
			playlists = msg;
			
			// display info for the first playlist
			
			html = '';
			counter = 0;
			playlists.forEach(function(playlist){
				if( counter === 3){
					// defaults to popular stuff
					document.selectedPlaylist = 3;
					html += '<div id="playlist_' + counter + '" class="album_art active">';
				} else {
					html += '<div id="playlist_' + counter + '" class="album_art">';
				}
				playlist.album_art.forEach(function(element) {
					html = html + '<img width="100px" height="100px" src="' + element + '" />';
				});
				html += '<div class="playlist-text"><b>' + playlist.name + '</b></br>'; 		
				html += playlist.amount_of_tracks + ' Tracks</br>'; 
				html += '<i>' + playlist.description + '</i>';
				html += '</div>';
				html += '</div>';
				counter++;
			});
						
			$("#playlist-selector").html(html);
			
			
			
			$("#playlist-selector").css("display","flex");
			
		});
});

function decreaseRoundTime(){
	
	$("#roundTime").html(document.RoundTime);

	if( document.RoundTime === 6){
		$("#player").animate({volume: 0}, 6000);
	}

	if( document.RoundTime > 0 ){
		document.RoundTime--;
		sleep(1000).then(() =>{
			decreaseRoundTime();
		});
	} else if (document.RoundTime != -10) {
		round_end();
		decreaseRoundTime();
	}
}

function start(){

	// reset scores of players
	document.playerScores = [];
	
	// reset guessing areas
	$("#player-results").html("");
	
	// reset the roundTime again, at the actual start of the round
	document.RoundTime = 30;
	
	// initiate round time keeptracker
	decreaseRoundTime();
	
	document.round = 0;
	$("#roundTime").html(document.RoundTime);
	$("#roundTime").css("display","flex");
	
	// hide playlist selector
	$("#playlist-selector").hide();
	
	
	// override screen with play area
	$("#screen-wrapper").html('<div class="instruction">Guess the artist or title that is currently playing!</div><div id="status"></div><div><img id="playanimation" src="audio.svg" /></div><div class="debug" id="current_artist"></div><div class="debug" id="current_title"></div><div class="debug" id="current_album"></div><div class="debug" id="current_year"></div><div class="debug" id="current_album_art"></div>');
	$(".debug").hide();
	
	// get list of songs, choose one at random
	$.ajax(
		{ method: "GET", url: "/game/playlists/playlist_" + playlists[document.selectedPlaylist].id + ".json", data: {} , dataType: "json" })
		.done(function( msg ) {
			library = msg;
			
			console.log(library);
			
			play_random_song();
		});
	
	// stores the current solution
	document.solution = [];
}

// Array Remove - By John Resig (MIT Licensed)
Array.prototype.remove = function(from, to) {
  var rest = this.slice((to || from) + 1 || this.length);
  this.length = from < 0 ? this.length + from : from;
  return this.push.apply(this, rest);
};

function randomIntFromInterval( min, max ){
    return Math.floor( Math.random() * ( max - min + 1 ) + min );
}

function play_random_song(){
	document.round++;
	
	$(".instruction").append(" Round " + document.round);
	
	randomSongIndex = randomIntFromInterval(0,library.length-1);
	randomSong = library[randomSongIndex];
	// remove song from the library so it will not get played more than once
	library.remove(randomSongIndex);
	
	// get wrong answers for multiple choice
	wrong_answers = 0;
	wrong_answers_array = [];
	while(wrong_answers < 3){
		// 50:50 chance that wrong answer is either artist or title
		artist_or_title = randomIntFromInterval( 0, 1 );	
		suitable_wrong_answer = true;
		wrongSongIndex = randomIntFromInterval(0,library.length-1);
		
		console.log("wrong song index " + wrongSongIndex);
		
		
		wrongSong = library[wrongSongIndex];
		if( artist_or_title === 0 ){
			// artist
			// check if the wrongSong has the same artist as the actual song
			if( wrongSong.artist === randomSong.artist ){
				suitable_wrong_answer = false;
			}
			// check if wrong contains right, or vice versa
			if( wrongSong.artist.indexOf(randomSong.artist) !== -1 && randomSong.artist.indexOf( wrongSong.artist ) ){
				suitable_wrong_answer = false;
			}
			// check if the selection is already in the array
			if( $.inArray( wrongSong.artist, wrong_answers_array ) !== -1 ){
				suitable_wrong_answer = false;
			}
			if( suitable_wrong_answer ){
				wrong_answers_array.push(wrongSong.artist);
			}
		} else {
			// title
			// check if the wrongSong has the same title as the actual song
			if( wrongSong.title === randomSong.title ){
				suitable_wrong_answer = false;
			}
			// check if wrong contains right, or vice versa
			if( wrongSong.title.indexOf( randomSong.title ) !== -1 && randomSong.title.indexOf( wrongSong.title ) !== -1 ){
				suitable_wrong_answer = false;
			}
			// check if the selection is already in the array
			if( $.inArray( wrongSong.title, wrong_answers_array ) !== -1 ){
				suitable_wrong_answer = false;
			}
			if( suitable_wrong_answer ){
				wrong_answers_array.push(wrongSong.title);
			}
		}
		if( suitable_wrong_answer ){
			wrong_answers++;
		}
	}

	console.log( "array of wrong answers" + wrong_answers_array );
	
	console.log("playing song " + randomSongIndex + " in library");
	console.log( randomSong );
	
	// remove previous player
	$("#player").remove();
		
	player = '<audio id="player" autoplay> <source src="' +  randomSong.preview_url + '" type="audio/mpeg"></audio>';
		
	$("body").append(player);

	// record start time
	document.startTime = new Date().getTime();
		
	// turn volume back up
	$("#player").prop("volume", "1");
	// $('#player').get(0).currentTime = 5;
	$("#playanimation").show();
	
	$("#current_artist").html(randomSong.artist);
	$("#current_title").html(randomSong.title);
	$("#current_album").html(randomSong.album);
	$("#current_year").html(randomSong.year);
	// $("#current_album_art").html('<img src="' + randomSong.albumArtRef[0].url + '" />');
	
	artist = randomSong.artist;
	title = randomSong.title;

	if( document.guessingMethod === 'letter' ){
		artist = artist.replace(/ /g,'').toUpperCase();
		title = title.replace(/ /g,'').toUpperCase();
	}

	document.solution = [];
	document.solution.push({ 
		type: "solution", 
		artist: artist, 
		title: title, 
		guessingMethod: document.guessingMethod,
		wrongAnswers: wrong_answers_array
	});
	// send the solution to all clients
	air_console.broadcast( document.solution );
}

// Listen for messages from other devices
air_console.onMessage = function(from, message) {
	// handle message
	var type = message[0].type;
	console.log('handling ' + type + ' message.');

	switch( type ){
		case 'guessMethodFull':
			// save the type of guessing method
			document.guessingMethod = 'full';
			// start the game
			start();
		break;
		case 'guessMethodLetter':
			// save the type of guessing method
			document.guessingMethod = 'letter';
			// start the game
			start();
		break;
		case 'nextSong':
			// reset guess areas
			$(".resetme").each(function(){
				$(this).html("");
			});
			play_random_song();
		break;
		case 'debug':
			if( debug ){
				// turn it off
				debug = false;
				$(".debug").hide();
			} else {
				// turn it on
				debug = true;
				$(".debug").show();
			}
		break;
		case 'wrongGuess':
		case 'correctGuess':
			handle_guess( message, from );
		break;
		case 'next_playlist':
			switch_playlist('next');
		break;
		case 'previous_playlist':
			switch_playlist('previous');
		break;
	}
};

function switch_playlist( type ){
	console.log("Handling switch of playlist to " + type );
	console.log("all playlists:");
	console.log(playlists);
	
	$("#playlist_" + document.selectedPlaylist).removeClass("active");
	
	if( type === "next" ){
		if( document.selectedPlaylist === playlists.length-1 ){
			document.selectedPlaylist = 0;
		} else {
			document.selectedPlaylist += 1;
		}
		$('#playlist-selector').animate({left: "-=210"}, 'fast');
	} else {
		// previous
		if( document.selectedPlaylist === 0 ){
			document.selectedPlaylist = playlists.length-1;
		} else {
			document.selectedPlaylist -= 1;
		}
		$('#playlist-selector').animate({left: "+=210"}, 'fast');
	} 
	
	$("#playlist_" + document.selectedPlaylist).addClass("active");
	
	console.log("newly selected playlist" + document.selectedPlaylist);
	
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function round_end(){

	
	// reset the roundTime so time cant run out in the time between matches
	document.RoundTime = 30;
	$("#roundTime").hide();

	debug = true;
	$(".debug").show();
	
	$("#playanimation").hide();
	$("#player").animate({volume: 0}, 6000);
	$(".instruction").html("Round is over!");
	
	sleep(4000).then(() =>{
		document.amount_of_finished_players = 0;
		debug = false;
		$(".debug").hide();
		
		if( document.round === document.maxRound ){
			// handle end of game
			$(".instruction").html("Game Over!");
			// set roundTime extra high so the end doesnt happen more than once
			document.RoundTime = -10;
			console.log("game over");
			
			game_end = [];
			game_end.push({ type: "game_end" });
			// send game end message to the controllers
			air_console.broadcast( game_end );
		} else {
			// initiate next round
			$(".instruction").html("Get ready for the next round!");
			$("#status").html("3");
			sleep(1000).then(() =>{
				$("#status").html("2");
				sleep(1000).then(() =>{
					$("#status").html("1");
					sleep(1000).then(() =>{
						$("#status").html("");
						$(".instruction").html("Guess the artist or title that is currently playing!");
						
						// reset all Points etc
						$(".score_change").html("&nbsp;");
						$(".current_time").html("&nbsp;");
						$(".single-result").css('background-color', 'rgba(0, 0, 0, 0.6)');
						// reset the roundTime again, at the actual start of the round
						document.RoundTime = 30;
						$("#roundTime").html(document.RoundTime);
						$("#roundTime").css("display","flex");
						play_random_song();
					});
				});
			});
		}
	});
}

function handle_guess( message, from ){
	// these vars only concern the current guess
	var finished_title = false;
	var finished_artist = false;

	console.log("Player " + from + " guessed a letter!");
	// check the length of the guess word versus the solution
	console.log(message[0].type_of_guess);
	
	// initialize the array that stores the general progress of the players
	if( ! document.player ){
		document.player = [];
	}
	
	// initialize the array for the current device
	if( ! document.player[from] ){
		// initialize array if not already present
		document.player[from] = [];
	}
	
	if( message[0].type_of_guess === 'title' ){
		if( document.solution[0].title.length === message[0].progress ){
			// player finished the title!
			finished_title = true;
			// save completion status of device to global var
			document.player[from].finished_title = true; 
		}
	} else if ( message[0].type_of_guess === 'artist' ){
		if( document.solution[0].artist.length === message[0].progress ){
			// player finished the artist!
			finished_artist = true;
			// save completion status of device to global var
			document.player[from].finished_artist = true; 
		}
	} 

	// check if the player already has a guess area
	guessArea = false;
	$("#player_" + from + "_result").each(function(){
		guessArea = true;
	});
	if( ! guessArea ){
		// determine nickname of player
		nickname = air_console.getNickname( from );
		// add empty guessArea
		if( document.guessingMethod === 'letter' ){
			$("#screen-wrapper").append('<div class="playerGuesses left" id="player_' + from +'"><div class="left" id="player_' + from +'_label">' + nickname + ':</div><div class="left resetme" id="player_' + from +'_artist"></div><div class="resetme"> - </div><div class="left resetme" id="player_' + from +'_title"> </div></div>');
		} else if ( document.guessingMethod === 'full' ){
			$("#player-results").append('<div class="single-result" id="player_' + from +'_result"><span class="position">1.</span><span class="current_score">0</span><span class="profile"><img src="http://www.teequilla.com/images/tq/empty-avatar.png"></span><span class="current_time"></span><span class="score_change">+2100</span><span class="player_name">' + nickname + '</span></div>');
		}
	}
	if( message[0].type_of_guess === 'title' ){
		$("#player_" + from + "_title").html(message[0].word);
	} else if ( message[0].type_of_guess === 'artist' ){
		$("#player_" + from + "_artist").html(message[0].word);
	} else if ( message[0].type_of_guess === 'full' ){
		guessTime = (new Date().getTime() - document.startTime);
		negative_points = Math.round(0.01 * guessTime);
		
		actual_points = 300 - negative_points;
		if(actual_points < 0) actual_points = 0;
		guessTime = guessTime / 1000;

		url = air_console.getProfilePicture(from);
		
		if( message[0].type !== "correctGuess" ){
			actual_points = 0;
		}
		
		newScore = actual_points;
		
		// try selecting current score
		playerScore = document.playerScores.filter(function(obj){
			return obj.player === from; 
		});
		
		if( playerScore[0] ){
			newScore = playerScore[0].score + actual_points;
			playerScore[0].score = newScore;
		} else {
			document.playerScores.push({ player: from, score: newScore });
		}
		
		console.log(document.playerScores);
		
		document.playerScores.sort(function(a,b) {
			if(a.score > b.score){
				return -1;
			}
			if(a.score < b.score){
				return 1;
			}
			return 0;
		});
		
		console.log(document.playerScores);
		
		resultArea = $("#player_" + from + "_result");
		resultArea.find(".profile img").attr("src",url);
		
		position = 1;
		document.playerScores.forEach(function(element){
			$("#player_" + element.player + "_result").find(".position").html(position + ".");
			position++;
		});
		
		if( message[0].type === "correctGuess" ){
			resultArea.find(".current_score").html(newScore);
			resultArea.find(".score_change").html("+ " + actual_points + " Points");
			resultArea.find(".current_time").html(guessTime + " seconds");
			resultArea.css('background-color', 'green');
		} else {
			resultArea.find(".score_change").html("No Points");
			resultArea.find(".current_time").html(guessTime + " seconds");
			resultArea.css('background-color', 'red');
			actual_points = 0;
		}
		document.amount_of_finished_players++;
		console.log("Currently Connected: " + air_console.getControllerDeviceIds().length);
		console.log("Amount of finished players: " + document.amount_of_finished_players);
		// in theory this should play the next song when all connected devices have finished
		// since a controller can join after the round has started, this is probably a blocker we need to handle
		if( document.amount_of_finished_players === air_console.getControllerDeviceIds().length){
			round_end();
		}
	}
	
	if( finished_title ){
		$("#player_" + from + "_title").css('color', 'green');
	} else {
		// reset color
		$("#player_" + from + "_title").css('color', 'black');
	}
	if( finished_artist ){
		$("#player_" + from + "_artist").css('color', 'green');
	} else {
		// reset color
		$("#player_" + from + "_artist").css('color', 'black');
	}
	
	// if global status says both artist and title are guessed correctly, display both of them green
	if ( document.player[from] && document.player[from].finished_title && document.player[from].finished_artist ){
		$("#player_" + from + "_title").css('color', 'green');
		$("#player_" + from + "_artist").css('color', 'green');
	}
}
</script>
	
</body>