<head>
	<script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
	<link rel="stylesheet" href="controller.css">
	<link rel="stylesheet" href="shared.css">
	<link href="https://fonts.googleapis.com/css?family=Oswald|Roboto" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Georama:wght@800&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@100&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@600&display=swap" rel="stylesheet">
</head>

<body onload="init()">
	<div id="background">
		<div class="screen">
			<div id="general-buttons">
				<div id="return-button-image" class="image-button"></div>
				<div id="select-button-image" class="image-button text-allign">
				  <div class="button-text">Select</div>
				</div>
			</div>
			<div id="navigation-buttons">
				<div id="up-button-image" class="image-button"></div>
				<div id="down-button-image" class="image-button"></div>
				<div id="left-button-image" class="image-button"></div>
				<div id="right-button-image" class="image-button"></div>
				<div id="miniLeft-button-image" class="image-button"></div>
				<div id="miniRight-button-image" class="image-button"></div>
			</div>
			<div id="specific-buttons">
				<div id="heroReq-button-image" class="image-button text-allign">
					<div id="hero-text" class="button-text">Hero</br>Required</div></div>
				</div>
				<div id="plus-button-image" class="image-button"></div>
				<div id="minus-button-image" class="image-button"></div>
			</div>
			<div id="back_from_updates_area"> 
				<div id="returnUpdate-button-image" class="image-button"></div>
		        <div id= "purple-blur" class="image-element text-allign">
                   <div class="button-text">Return to main menu</div>
                </div>
			</div>
			<div id="back_from_credits_area">
				<div id="credits" class="image-element text-allign">
					<span id="category" class="button-text">Developed by:</br></span>
					<span id="content" class="button-text"></br>Christian Nyffenegger, freakpants</br></span></span><br>
					<span id="category" class="button-text">Background video by:</br></span>
					<span id="content" class="button-text">  </br>Tomislav Jakupec </span> / Pixabay </br></span><br>
					<span id="category" class="button-text">Music provided by:</br></span>
					<span id="content" class="button-text"></br>Itunes Search API Preview</br></span></span><br>
					<span id="category" class="button-text">Sound effects by:</br></span>
					<span id="content" class="button-text"></br>ZapSplat</br></span></span><br>
					<span id="category" class="button-text">Svg loaders by:</br></span>
					<span id="content" class="button-text"></br>Sam Herbert</span>Github</span></br></span><br>
				</div>
				<div id="returnCredits-button-image" class="image-button"></div>
		        <div id= "purple-blur-credits" class="image-element text-allign">
                  <div class="button-text">Return to main menu</div>
                </div>
			</div>
			<div id="loading">
				<div id="loading-container" class="image-element">
					<img id="loading_animation" src="three-dots.svg"/>
				</div>
				<div id= "purple-blur" class="image-element text-allign">
			      <div class="button-text" style="left: 40%; top:44%; position: absolute; font-size: min(2.6vh, 4.2vw);">Loading</div>
			    </div>
			</div>
			<div id="get_ready">
				<div id="message-container" class="image-element text-allign">Get</br>ready</br>to</br>guess!</div>
			</div>
			<div id="score_report">
				<div id="message-container" class="image-element text-allign">
					<span class='result button-text'></span>
				</div>
			</div>
			<div id="waiting_for_start">
				<div id="message-container" class="image-element text-allign">Please wait for</br>the master</br>controller to</br>start the game.</div>
			</div>
			<div id="waiting_for_next_round">
				<div id="message-container" class="image-element text-allign">Please wait for</br>the next round</br>to begin.</div>
			</div>
			<div id="guessing_buttons_full">
				<div id="position-image" class="position-display image-button text-allign">
					<span class="number button-text"></span>
					<span class="letters button-text"></span>
				</div>
				<div id="return-menu-button" class="image-button"></div>
				<div id="choice_1" class="choice_container unselected">
					<!-- <span class="fa-stack fa-lg">
						<i class="fa fa-bars "></i>
					</span> -->
					<div class="choice_1 unselected image-button text-allign">Text Text Text Text Text Text Text Text Text</div>
				</div>
				<div id="choice_2" class="choice_container unselected">
					<!-- <span class="fa-stack fa-lg">
						<i class="fa fa-bars "></i>
					</span> -->
					<div class="choice_2 unselected image-button text-allign"></div>
				</div>
				<div id="choice_3" class="choice_container unselected">
					<!-- <span class="fa-stack fa-lg">
						<i class="fa fa-bars "></i>
					</span> -->
					<div class="choice_3 unselected image-button text-allign"></div>
				</div>
				<div id="choice_4" class="choice_container unselected">
					<!-- <span class="fa-stack fa-lg">
						<i class="fa fa-bars "></i>
					</span> -->
					<div class="choice_4 unselected image-button text-allign"></div>
				</div>
				<div id="panelguess"></div>
			</div>
			<div id="round_over_song_details">
				<div class="result_banner image-element text-allign">
					<div class="player_round_result button-text"></div>
					<div class="player_score button-text"></div>
				</div>
				<div id="position-image" class="position-display image-button text-allign">
					<span class="number button-text"></span>
					<span class="letters button-text"></span>
				</div>
				<div class="image">
					<div class="song_albumart image-element" onclick="air_console.openExternalUrl(buy_link)">
						<div class="song_buylink">
						</div>
		
					</div>
				</div>
				<div class="text_info image-element text-allign">
					<span class="song_title button-text"></span>
					<span class="song_album button-text"></span>
					<span class="song_artist button-text"></span>
				</div>
			</div>
			<div id="quit_match">
				<div id= "purple-blur-quit" class="image-element text-allign">
				   <div class="button-text">leave the match?</div>
				</div>
				<div id="yes-button-image" class="image-button text-allign">
				   <div class="button-text">Yes</div>
				</div>
				<div id="no-button-image" class="image-button text-allign">
				   <div class="button-text">No</div>
				</div>
			</div>
			<div id="game_over">
				<div id="returnGameOver-button-image" class="image-button"></div>
		        <div id= "purple-blur" class="image-element text-allign">
                   <div class="button-text">Return to main menu</div>
                </div>
			</div>
	    </div>	
	</div>

	</div>

	<script type="text/javascript">
		var air_console;
		var buy_link = "https://www.apple.com/lae/music/";
		document.maxRound = 25;
		document.showing_result_screen = false;
		document.currentScore = 0;
		//whether or not to display all information
		const DEBUG = true;

		function init() {
			air_console = new AirConsole();
			// Listen for messages from other devices
			air_console.onMessage = function (from, data) {

				// console.log("received message " + data[0].type);
				if (data === undefined || data[0] === undefined || data[0].type === undefined) {
					return;
				}

				if (data[0].type === "display_loading") {
					if (am_i_master()) {
						$("#up-button-image").hide();
					    $("#down-button-image").hide();
						$("#left-button-image").hide();
						$("#right-button-image").hide();
						$("#select-button-image").hide();
						$("#loading").css("display", "flex");
					}
				}

				if (data[0].type === "hide_loading") {
					DEBUG && console.log("hiding loading, and showing menu");
					if (am_i_master()) {
						$("#loading").hide();
					}
				}

				if (data[0].type === "disable_start") {
					if (am_i_master()) {
					$("#select-button-image").hide();
					$("#heroReq-button-image").show();
					}
				}

				if (data[0].type === "enable_start" && data[0].type !== "display_loading") {
					if (am_i_master()) {
					$("#select-button-image").show();
					$("#heroReq-button-image").hide();
					}
				}

				if (data[0].type === "start_with_hero") {
					if (am_i_master()) {
					$("#select-button-image").show();
					$("#heroReq-button-image").hide();
					}
				}

				if (data[0].type === "inactive") {
					// if there is a round in progress, and the client is inactive hide the menu and display the wait message instead
					DEBUG && console.log("controller " + air_console.getDeviceId() + " has received message inactive");
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#select-button-image").hide();
					$("#return-button-image").hide();
                    $("#heroReq-button-image").hide();
					$("#waiting_for_next_round").css({ display: "flex" });
					$("#waiting_for_start").hide();
				}

				if (data[0].type === "in_progress") {
					// if there is a game in progress, store that info for check_master
					DEBUG && console.log("controller " + air_console.getDeviceId() + " has received message in progress");
					document.inProgress = true;
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#select-button-image").hide();
					$("#return-button-image").hide();
				}

				if (data[0].type === "show_menu") {
					$("#guessing_buttons_full").hide();
					$("#waiting_for_next_round").hide();
					$("#waiting_for_start").hide();
					$("#game_over").hide();
					$("#quit_match").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#up-button-image").show();
					$("#down-button-image").show();
					$("#select-button-image").show();
				}

				if (data[0].type === "show_back_from_credits") {
					DEBUG && console.log("received instruction to show credits on controller");
					if (am_i_master()) {
						DEBUG && console.log("hiding menu and showing back from credits area with clickable links");
						$("#waiting_for_next_round").hide();
						$("#waiting_for_start").hide();
						$("#loading").hide();
						$("#up-button-image").hide();
					    $("#down-button-image").hide();
						$("#select-button-image").hide();
						$("#back_from_credits_area").show();
					}
				}

				if (data[0].type === "show_back_from_updates") {
					DEBUG && console.log("received instruction to show updates on controller");
					if (am_i_master()) {
						DEBUG && console.log("hiding menu and showing back from updates area with clickable links");
						$("#waiting_for_next_round").hide();
						$("#waiting_for_start").hide();
						$("#loading").hide();
						$("#up-button-image").hide();
					    $("#down-button-image").hide();
						$("#select-button-image").hide();
						$("#back_from_updates_area").show();
					}
				}

				// show the previous/next button on the playlist selection screen
				if (data[0].type === "show_playlist_buttons") {
					if (am_i_master()) {
					$("#waiting_for_start").hide();
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#return-button-image").show();
					$("#left-button-image").show();
					$("#right-button-image").show();
					$("#select-button-image").show();
					}
				}

				if (data[0].type === "show_round_number_buttons") {
					if (am_i_master()) {
					$("#waiting_for_next_round").hide();
					$("#waiting_for_start").hide();
					$("#miniLeft-button-image").hide();
					$("#miniRight-button-image").hide();
					$("#plus-button-image").hide();
					$("#minus-button-image").hide();
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#return-button-image").show();
					$("#left-button-image").show();
					$("#right-button-image").show();
					$("#select-button-image").show();
					}
				}

				if (data[0].type === "hide_round_number_buttons") {
					if (am_i_master()) {
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#return-button-image").show();
					$("#up-button-image").show();
					$("#down-button-image").show();
					}
				}

				if (data[0].type === "show_settings_buttons") {
					if (am_i_master()) {
					$("#waiting_for_next_round").hide();
					$("#waiting_for_start").hide();
					$("#miniLeft-button-image").hide();
					$("#miniRight-button-image").hide();
					$("#plus-button-image").hide();
					$("#minus-button-image").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#return-button-image").show();
					$("#up-button-image").show();
					$("#down-button-image").show();
					$("#select-button-image").show();
					}
				}

				if (data[0].type === "show_main_menu_buttons") {
					if (am_i_master()) {
					$("#quit_match").hide();
					$("#return-button-image").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#up-button-image").show();
					$("#down-button-image").show();
					$("#select-button-image").show();
					}
				}

				if (data[0].type === "show_back_to_main") {
					$("#waiting_for_next_round").hide();
					$("#waiting_for_start").hide();
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#select-button-image").hide();
					$("#score_report").hide();
					$("#game_over").css({ display: "flex" });
				}

				if (data[0].type === "hide_cancel") {
					$("#cancel_round").hide();
				}

				if (data[0].type === "hide_menu") {
					if (!am_i_master()) {
						$("#guessing_buttons_full").hide();
						$("#position").hide();
						$("#round_over_song_details").hide();
						$("#waiting_for_next_round").hide();
						$("#up-button-image").hide();
						$("#down-button-image").hide();
						$("#miniLeft-button-image").hide();
					    $("#miniRight-button-image").hide();
					    $("#plus-button-image").hide();
					    $("#minus-button-image").hide();
						$("#right-button-image").hide();
						$("#left-button-image").hide();
						$("#select-button-image").hide();
						$("#return-button-image").hide();
						$("#back_from_credits_area").hide();
						$("#back_from_updates_area").hide();
                        $("#heroReq-button-image").hide();
						$("#game_over").hide();
						$("#quit_match").hide();
						$("#waiting_for_start").show();
						$("#panelguess").css('opacity', '0');
						$("#panelguess").css('pointer-events', 'none');
					}
				}

				if (data[0].type === "show_round_change_buttons") {
					if (am_i_master()) {
						$("#waiting_for_next_round").hide();
					    $("#waiting_for_start").hide();
						$("#left-button-image").hide();
					    $("#right-button-image").hide();
						$("#up-button-image").hide();
					    $("#down-button-image").hide();
						$("#return-button-image").show();
						$("#miniLeft-button-image").show();
					    $("#miniRight-button-image").show();
					    $("#plus-button-image").show();
					    $("#minus-button-image").show();
						$("#select-button-image").show();
					}
				}

				if (data[0].type === "hide_round_change_buttons") {
					if (am_i_master()) {
					$("#waiting_for_next_round").hide();
					$("#waiting_for_start").hide();
					$("#miniLeft-button-image").hide();
					$("#miniRight-button-image").hide();
					$("#plus-button-image").hide();
					$("#minus-button-image").hide();
					$("#return-button-image").show();
					$("#left-button-image").show();
					$("#right-button-image").show();
					$("#select-button-image").show();
					}
				}
				
				if (data[0].type === "get_ready") {
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#select-button-image").hide();
					$("#return-button-image").hide();
					$("#waiting_for_start").hide();
					$("#message-container").show();
					$("#get_ready").show();
				}

				if (data[0].type === "not_in_progress") {
					// if there is no game in progress, store that info for check_master
					DEBUG && console.log("controller " + air_console.getDeviceId() + " has received message NOT in progress");
					document.inProgress = false;
				}

				if (data[0].type === "out_of_time") {
					// canceling with timers going on is a bad idea
					$("#cancel_round").hide();
					if (!document.showing_result_screen) {
						$(".player_score").html(document.currentScore + " Points (+" + 0 + ")");
						DEBUG && console.log("received out of time message");
						show_result_screen("out_of_time");
					}
				}

				if (data[0].type === "skipping") {
					// we do not check if the player is already viewing the result screen, because at this point he probably still is from last round
					if (!document.showing_result_screen) {
						$(".player_score").html(document.currentScore + " Points (+" + 0 + ")");
						DEBUG && console.log("received skipping message");
						show_result_screen("skipping");
					}
				}

				if (data[0].type === "playlist_rounds") {
					document.maxPlaylistRounds = data[0].playlist_rounds;
					// when switching playlists, the round amount can be too high, fix this
					if (document.maxRound > document.maxPlaylistRounds) {
						document.maxRound = document.maxPlaylistRounds;
						$("#round_amount").html(document.maxRound);
					}
					decrease_check();
					increase_check();
				}

				if (data[0].type === "round_change") {
					document.maxRound = data[0].maxRound;
					$("#round_amount").html(document.maxRound);
					decrease_check();
					increase_check();
				}

				if (data[0].type === "score") {
					// console.log("received score");
					// also store the current score for display when out of time 
					const score = data[0].score;
					document.currentScore = score.score;
					document.position = score.position;
					if (score.increase !== undefined) {
						// there are two types of score report. only report the increase if it actually was sent
						$(".player_score").html(score.score + " Points (+" + score.increase + ")");
					}

					$("#message-container").hide();
					// </br>You are on Position " + document.position

					// assign score for the permanent display
					$(".number").html(score.position);
					switch (score.position) {
						case 1:
							$(".number").html(score.position + "ST");
							$("#guessing_buttons_full .position-display").css("opacity", "1");
							$("#round_over_song_details .position-display").css("opacity", "1");
							break;
						case 2:
							$(".number").html(score.position + "ND");
							$("#guessing_buttons_full .position-display").css("opacity", "1");
							$("#round_over_song_details .position-display").css("opacity", "1");
							break;
						case 3:
							$(".number").html(score.position + "RD");
							$("#guessing_buttons_full .position-display").css("opacity", "1");
							$("#round_over_song_details .position-display").css("opacity", "1");
							break;
						default:
							$(".number").html(score.position + "TH");
							$("#guessing_buttons_full .position-display").css("opacity", "1");
							$("#round_over_song_details .position-display").css("opacity", "1");
							break;
					}
				}

				if (data[0].type === "score_report") {
					DEBUG && console.log("controller received score report");
					const score = data[0].score;
					const maxRound = data[0].maxRound;
					const correctGuesses = score.correctGuesses;
					const totalGuessTime = score.totalGuessTime;

					let message = '<span class="score_report_title button-text"</br>';
					switch (score.position) {
						case 1:
							message += "You have won<br>the game!</br>";
							break;
						case 2:
							message += "You came<br>in second!</br>";
							break;
						case 3:
							message += "You placed third!</br>";
							break;
						default:
							message += "You are on the<br>" + score.position + "th place</br>";
							break;
					}
					message += "</span><span class='result_category button-text'><br>Correct guesses:</br></span>";
					message += "<span class='result_count button-text'></br>" + correctGuesses + "/" + maxRound + " (" + Math.round(100 / maxRound * correctGuesses) + "%)</br></span></br>";
					message += "<span class='result_category button-text'>Total time taken for guesses:</br></span>";
					message += "<span class='result_count button-text'></br>" + Math.round(totalGuessTime * 10) / 10 + " seconds</br></span></br>";
					message += "<span class='result_category button-text'>Average time guessing:</br></span>";
					message += "<span class='result_count button-text'></br>" + + Math.round(totalGuessTime / maxRound * 10) / 10 + " seconds</br></span></br>";
					$("#score_report .button-text").html(message);
					$("#score_report").show();
				}

				if (data[0].type === "game_end") {
					document.inProgress = false;
					DEBUG && console.log("handling game end");
					$("#guessing_buttons_full .position-display").css("opacity", "0");
					$("#round_over_song_details .position-display").css("opacity", "0");
					$("#return-menu-button").hide();
					$("#guessing_buttons_full #choice_1").css('opacity', '1');
					$("#guessing_buttons_full #choice_2").css('opacity', '1');
					$("#guessing_buttons_full #choice_3").css('opacity', '1');
					$("#guessing_buttons_full #choice_4").css('opacity', '1');

					$("#guessing_buttons_full #choice_1").removeClass("correct-selected wrong-selected");
					$("#guessing_buttons_full #choice_2").removeClass("correct-selected wrong-selected");
					$("#guessing_buttons_full #choice_3").removeClass("correct-selected wrong-selected");
					$("#guessing_buttons_full #choice_4").removeClass("correct-selected wrong-selected");

					$("#guessing_buttons_full").hide();
					$("#round_over_song_details").hide();
					$("#message-container").hide();

					//  hide the menu
					$("#message-container").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#return-button-image").hide();
					$("#select-button-image").hide();

					// reset the live score
					$("#round_over_song_details .number").html("");
					$("#round_over_song_details .letters").html("");

					// unnattach all event handlers so we dont start triggering multiple messages 
					$(".correct").off();
					$(".wrong").off();

					// should be a custom setting so the players have time to analyze the results
					sleep(14000).then(() => {
						$("#score_report").hide();
						$("#position").hide();

						if (am_i_master()) {
							$("#game_over").css("display", "flex");
						} else {
							$("#waiting_for_start").css("display", "flex");
						}

					});

				}

				if (data[0].type === "quit_match") {
					if (am_i_master()) {
					$("#guessing_buttons_full").hide();
					$("#quit_match").show();
					} else{
						$("#panelguess").css('opacity', '1');
						$("#panelguess").css('pointer-events', 'auto');
					}
				}

				if (data[0].type === "return_match") {
					if (am_i_master()) {
					$("#guessing_buttons_full").show();
					$("#quit_match").hide();
					} else{
						$("#panelguess").css('opacity', '0');
						$("#panelguess").css('pointer-events', 'none');
					}
				}

				// analyze data
				if (data[0].type === "solution") {
					// switch state back to not displaying the result so we know if we can switch to it or not
					document.showing_result_screen = false;

					show_or_hide_round_cancel_button();

					// hide the waiting_for_next_round message if it was showing
					$("#waiting_for_next_round").hide();

					// show the position
					$("#position").show();

					// hide the get ready message
					$("#get_ready").hide();

					// console.log('received solution');
					// unnattach all event handlers so we dont start triggering multiple messages 		
					$(".correct").off();
					$(".wrong").off();

					// hide the song area from previous rounds
					$("#round_over_song_details").hide();

					// push the correct information from the song to the round over screen
					if (data[0].title.length > 25) {
						$(".song_artist").html(data[0].artist.substring(0, 25) + "..." + '</br>');
					} else{
						$(".song_artist").html(data[0].artist + '</br>');
					}
                    if (data[0].title.length > 25) {
						$(".song_title").html(data[0].title.substring(0, 25) + "..." + '</br>');
                    } else{
					    $(".song_title").html(data[0].title + '</br>');
					}
					if (data[0].album.length > 25) {
						$(".song_album").html(data[0].album.substring(0, 25) + "..." + '</br>');
					} else{
					    $(".song_album").html(data[0].album + '</br>');
					}

					//Set the low resolution image while the highest resolution image has not finished loading
					var albumResolution = new Image();
					albumResolution.src = data[0].album_art.replace('/1000x1000', '/100x100');
					albumResolution.onload = function(){
						//if loaded the low resolution image, load the larger one
						if(albumResolution.src == data[0].album_art.replace('/1000x1000', '/100x100')){
							albumResolution.src = data[0].album_art;
						}
						$(".song_albumart").css('background-image', 'url(' + albumResolution.src + ')');
					}

					buy_link = data[0].buy_link;

					if (am_i_master()) {
						$("#return-menu-button").show();
					}

					// reset css on buttons
					$("#guessing_buttons_full #choice_1").css('opacity', '1');
					$("#guessing_buttons_full #choice_2").css('opacity', '1');
					$("#guessing_buttons_full #choice_3").css('opacity', '1');
					$("#guessing_buttons_full #choice_4").css('opacity', '1');
					$("#return-button-image").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#select-button-image").hide();

					$("#guessing_buttons_full #choice_1").removeClass("correct-selected wrong-selected");
					$("#guessing_buttons_full #choice_2").removeClass("correct-selected wrong-selected");
					$("#guessing_buttons_full #choice_3").removeClass("correct-selected wrong-selected");
					$("#guessing_buttons_full #choice_4").removeClass("correct-selected wrong-selected");

					//  hide the menu
					$("#message-container").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#return-button-image").hide();
					$("#select-button-image").hide();

					artist_or_title = data[0].answerType;
					choices = data[0].wrongAnswers;
					// console.log(choices);
					if (artist_or_title === 0) {
						// add artist to array of choices
						choices.push(data[0].artist);
					} else {
						// add title to array of choices
						choices.push(data[0].title);
					}

					shuffle(choices);
					// console.log( "choices: " + choices );

					for (var counter = 1; counter < 5; counter++) {
						current_choice = choices[counter - 1];
						targetElement = $("#guessing_buttons_full #choice_" + counter);
						targetElement.removeClass("wrong");
						targetElement.removeClass("correct");
						if (artist_or_title === 0) {
							// check artist against current choice
							if (current_choice === data[0].artist) {
								targetElement.addClass("correct");
							} else {
								targetElement.addClass("wrong");
							}
						} else {
							// check title against current choice
							if (current_choice === data[0].title) {
								targetElement.addClass("correct");
							} else {
								targetElement.addClass("wrong");
							}
						}
						var choiceText = current_choice;
                        if (choiceText.length > 35) {
                          choiceText = choiceText.substring(0, 35) + "...";
                        }
						$(targetElement).find(".unselected").html(current_choice);
					}

					// handle correct multiple choice answer
					$(".correct").bind('touchstart mousedown', function (event) {
						event.preventDefault(); 
						// disable all buttons
						disable_guessing_buttons_event_handlers();

						show_or_hide_round_cancel_button();

						// let the screen know somebody got it right
						// console.log("handling correct guess on controller");
						var correctGuess = [];
						correctGuess.push({ type: "correctGuess", type_of_guess: 'full' });
						air_console.message(0, correctGuess);

						// highlight the correct answer
						id = $(this).attr("id");
						// console.log("id of element is " + id);
						$("#guessing_buttons_full #" + id).css('opacity', '1');
						$("#panelguess").css('opacity', '0.8');
						$(".image").css('background-color', '#00A100');
						$("#guessing_buttons_full #" + id).addClass('correct-selected');

						// this is the scrolling effect for the title, currently not needed, left in just in case
						animatethis($('.song_title'), 3000);

						// already switch to true, so that we dont get two different result types if we answer in the last 2 seconds
						document.showing_result_screen = true;

						// wait 2 seconds, then display the correct result including link to buy the song
						sleep(2000).then(() => {
							DEBUG && console.log("2 seconds after a correct guess have passed, we are showing the result screen");
							$("#panelguess").css('opacity', '0');
							show_result_screen("correct");
						});
					});

					// handle wrong multiple choice answer
					$(".wrong").bind('touchstart mousedown', function (event) {
						event.preventDefault(); 
						// disable all buttons
						disable_guessing_buttons_event_handlers();

						show_or_hide_round_cancel_button();

						// let the screen know somebody got it wrong
						// console.log("handling wrong guess on controller");
						var wrongGuess = [];
						wrongGuess.push({ type: "wrongGuess" });
						air_console.message(0, wrongGuess);

						// highlight the wrong answer
						id = $(this).attr("id");
						// console.log("id of element is " + id);
						$("#guessing_buttons_full #" + id).css('opacity', '1');
						$("#panelguess").css('opacity', '0.8');
						$(".image").css('background-color', '#F50B1E');
						$("#guessing_buttons_full #" + id).addClass('wrong-selected');

						// flash the correct answer 
						// console.log("flashing correct answer");
						$(".correct").addClass('correct-selected');
						$(".correct").css('opacity', '1');
						$(".correct").fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200);

						animatethis($('.song_title'), 3000);

						// already switch to true, so that we dont get two different result types if we answer in the last 2 seconds
						document.showing_result_screen = true;
						// wait 2 seconds, then display the correct result including link to buy the song
						sleep(2000).then(() => {
							DEBUG && console.log("2 seconds after a wrong guess have passed, we are showing the result screen");
							$("#panelguess").css('opacity', '0');
							show_result_screen("wrong");
						});
					});

					// display the guessing buttons
					$("#guessing_buttons_full").show();
				}
			}
		}

		$(document).ready(function () {

			$("#select-button-image").bind('pointerdown', function (event) {
				var command = [];
				command.push({ type: "select" });
				air_console.message(0, command);
			});

			$("#heroReq-button-image").bind('pointerdown', function (event) {
				air_console.getPremium();
			});

			$("#return-button-image, #returnUpdate-button-image, #returnCredits-button-image").bind('pointerdown', function (event) {
				$("#heroReq-button-image").hide();
				var command = [];
				command.push({ type: "back" });
				air_console.message(0, command);
			});

			$("#up-button-image, #left-button-image, #miniLeft-button-image, #previous-button").bind('pointerdown', function (event) {
				var command = [];
				command.push({ type: "previous" });
				air_console.message(0, command);
			});

            $("#down-button-image, #right-button-image, #miniRight-button-image, #next-button").bind('pointerdown', function (event) {
				var command = [];
				command.push({ type: "next" });
				air_console.message(0, command);
			});

			$("#minus-button-image").bind('pointerdown', function (event) {
				if (document.maxRound == 1) {
					// dont decrease rounds below 1
				} else {
					document.maxRound = document.maxRound - 1;
					decrease_check();

					$("#round_amount").html(document.maxRound);
					var command = [];
					command.push({ type: "decrease_rounds" });
					air_console.message(0, command);
				}
			});

			$("#plus-button-image").bind('pointerdown', function (event) {
				if (document.maxRound === document.maxPlaylistRounds) {
					// cant increase further
				} else {
					document.maxRound = document.maxRound + 1;
					increase_check();

					$("#round_amount").html(document.maxRound);
					var command = [];
					command.push({ type: "increase_rounds" });
					air_console.message(0, command);
				}
			});

			$("#return-menu-button").bind('pointerdown', function (event) {
				var command = [];
				command.push({ type: "quit_match" });
				air_console.message(0, command);
			});

			$("#yes-button-image").bind('pointerdown', function (event) {
				var command = [];
				command.push({ type: "yes" });
				air_console.message(0, command);
			});

			$("#no-button-image").bind('pointerdown', function (event) {
				var command = [];
				command.push({ type: "no" });
				air_console.message(0, command);
			});

			$("#cancel_round").bind('pointerdown', function (event) { 
				$("#round_over_song_details").hide();
				$("#loading").css({ display: "flex" });
				sleep(1500).then(() => {
					$("#loading").hide();
					$("#left-button-image").hide();
					$("#right-button-image").hide();
					$("#up-button-image").hide();
					$("#down-button-image").hide();
					$("#return-button-image").hide();
					$("#select-button-image").hide();
				});
				var command = [];
				command.push({ type: "cancel" });
				air_console.message(0, command);
			});

			$("#returnGameOver-button-image").bind('pointerdown', function (event) {
				$("#game_over").hide();
				$("#loading").css({ display: "flex" });
				sleep(1500).then(() => {
					$("#loading").hide();
					$("#up-button-image").show();
					$("#down-button-image").show();
					$("#select-button-image").show();
				});
				var command = [];
				command.push({ type: "back_to_main" });
				air_console.message(0, command);
			});

			$("#returnUpdate-button-image, #returnCredits-button-image").bind('pointerdown', function (event) {
				// inform the screen to display the animation
				var command = [];
				command.push({ type: "back" });
				air_console.message(0, command);

				$("#back_from_credits_area").hide();
				$("#back_from_updates_area").hide();
				$("#loading").css({ display: "flex" });
				// wait for the animation on the screen to finish
				sleep(3100).then(() => {
					$("#loading").hide();
					// check if we are the master controller
					if (am_i_master()) {
						$("#up-button-image").show();
						$("#down-button-image").show();
						$("#select-button-image").show();
					} else {
						$("#waiting_for_start").css({ display: "flex" });
					}
				});
			});
		});

		function am_i_master() {
			return (air_console.getMasterControllerDeviceId() !== undefined && air_console.getMasterControllerDeviceId() === air_console.getDeviceId());
		}

		/* these functions check for the boundaries of the amonut of rounds */
		function increase_check() {
			// if the max number of rounds is reached, hide the increase button
			if (document.maxRound === document.maxPlaylistRounds) {
				$(".increase_rounds").children().hide();
			}
			// if the new value is higher than 1, show the decrease button again
			if (document.maxRound > 1) {
				$(".decrease_rounds").children().show();
			}
		}

		function show_or_hide_round_cancel_button() {
			if (am_i_master()) {
				$("#cancel_round").show();
			} else {
				$("#cancel_round").hide();
			}
		}

		function decrease_check() {
			// if the new value is below the limit, show the increase button again
			if (document.maxRound < document.maxPlaylistRounds) {
				$(".increase_rounds").children().show();
			}
			// if the new value is exactly 1, hide the decrease button so we dont get 0 rounds
			if (document.maxRound === 1) {
				$(".decrease_rounds").children().hide();
			}
		}

		function show_result_screen(type) {
			DEBUG && console.log("showing result screen");
			document.showing_result_screen = true;

			// hide all guessing buttons
			$("#guessing_buttons_full").hide();
			// unhide player result area
			$("#round_over_song_details").css("display", "flex");
			//inform player of result
			$(".result_banner").removeClass("wrong");
			$(".result_banner").removeClass("correct");
			if (type === "out_of_time") {
				$(".result_banner").addClass("wrong");
				$(".player_round_result").html("Out of time!");
			} else if (type === "skipping") {
				$(".result_banner").addClass("wrong");
				$(".player_round_result").html("Skipped broken song.");
			} else {
				$(".result_banner").addClass(type);
				$(".player_round_result").html(type + "!");
			}
		}

		function disable_guessing_buttons_event_handlers() {
			// unnattach all event handlers so we dont start triggering multiple messages
			// console.log("disabling all buttons on controller, because the player guessed.");
			$(".correct").off();
			$(".wrong").off();
		}

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

		function animatethis(targetElement, speed) {
			var scrollWidth = $(targetElement).get(0).scrollWidth;
			var clientWidth = $(targetElement).get(0).clientWidth;
			$(targetElement).animate({ scrollLeft: scrollWidth - clientWidth },
				{
					duration: speed,
					complete: function () {
						targetElement.animate({ scrollLeft: 0 },
							{
								duration: speed,
								complete: function () {
									animatethis(targetElement, speed);
								}
							});
					}
				});
		};
		/**
		 * Shuffles array in place.
		 * @param {Array} a items The array containing the items.
		 */
		function shuffle(a) {
			var j, x, i;
			for (i = a.length; i; i--) {
				j = Math.floor(Math.random() * i);
				x = a[i - 1];
				a[i - 1] = a[j];
				a[j] = x;
			}
		}

	</script>

</body>