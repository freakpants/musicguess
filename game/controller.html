<head>
<script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.6.0.js"></script>
  <link rel="stylesheet" href="controller.css">
  <link rel="stylesheet" href="shared.css">
  <link href="https://fonts.googleapis.com/css?family=Oswald|Roboto" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>
	
<body>

<div id="guessing_methods">
	<div id="guessing_method_full"  class="unselected">Start the game with 25 rounds!</div>
	<div id="next_playlist"  class="unselected">Next Playlist</div>
	<div id="previous_playlist"  class="unselected">Previous Playlist</div>
</div>

<div id="guessing_buttons_full">
	<div class="choice_1 unselected" id="choice_1"></div>
	<div class="choice_2 unselected" id="choice_2"></div>
	<div class="choice_3 unselected" id="choice_3"></div>
	<div class="choice_4 unselected" id="choice_4"></div>
</div>

<div id="round_over_song_details">
	<div class="song_albumart"></div>
	<div class="player_round_result"></div>
	<div class="player_score"></div>
	
	<div class="text_info">
		<div class="song_title"></div>
		<div class="song_album"></div>
		<div class="song_artist"></div>
		<div class="song_buylink"></div>
	</div>
</div>

<script type="text/javascript">
var air_console = new AirConsole();

function animatethis(targetElement, speed) {
    var scrollWidth = $(targetElement).get(0).scrollWidth;
    var clientWidth = $(targetElement).get(0).clientWidth;
    $(targetElement).animate({ scrollLeft: scrollWidth - clientWidth },
    {
        duration: speed,
        complete: function () {
            targetElement.animate({ scrollLeft: 0 },
            {
                duration: speed,
                complete: function () {
                    animatethis(targetElement, speed);
                }
            });
        }
    });
};

/**
 * Shuffles array in place.
 * @param {Array} a items The array containing the items.
 */
function shuffle(a) {
    var j, x, i;
    for (i = a.length; i; i--) {
        j = Math.floor(Math.random() * i);
        x = a[i - 1];
        a[i - 1] = a[j];
        a[j] = x;
    }
}

$("#guessing_method_full").click(function( event ){
	// instruct the screen to start the game in full word mode
	var command = [];
	command.push({ type: "guessMethodFull" });
	air_console.message( 0 , command );
});

$("#next_playlist").click(function( event ){
	var command = [];
	command.push({ type: "next_playlist" });
	air_console.message( 0 , command );
});

$("#previous_playlist").click(function( event ){
	var command = [];
	command.push({ type: "previous_playlist" });
	air_console.message( 0 , command );
});



// Listen for messages from other devices
air_console.onMessage = function(from, data) {
	
	if( data[0].type === "score" ){
		console.log("received score");
		$(".player_score").html(data[0].score + " Points (+" + data[0].increase + ")");
	}
	
	if( data[0].type === "game_end" ){
		console.log("handling game end");
		$("#guessing_buttons_full .choice_1").css('opacity', '1');
		$("#guessing_buttons_full .choice_2").css('opacity', '1');
		$("#guessing_buttons_full .choice_3").css('opacity', '1');
		$("#guessing_buttons_full .choice_4").css('opacity', '1');
			
		$("#guessing_buttons_full .choice_1").removeClass("correct-selected wrong-selected");
		$("#guessing_buttons_full .choice_2").removeClass("correct-selected wrong-selected");
		$("#guessing_buttons_full .choice_3").removeClass("correct-selected wrong-selected");
		$("#guessing_buttons_full .choice_4").removeClass("correct-selected wrong-selected");
		
		$("#guessing_buttons_full").hide();
		
		// show the start command
		$("#guessing_methods").show();

		// unnattach all event handlers so we dont start triggering multiple messages 
		
		$(".correct").off();
		$(".wrong").off();
	}
	
	// analyze data
	if ( data[0].type === "solution" ){
		// hide the guessing type selection
		$("#guessing_methods").hide();
		console.log('received solution');
		// unnattach all event handlers so we dont start triggering multiple messages 		
		$(".correct").off();
		$(".wrong").off();
		
		if( data[0].guessingMethod === 'full' ){
			// hide the song area from previous rounds
			$("#round_over_song_details").hide();
	
			// push the correct information from the song to the round over screen
			$(".song_artist").html(data[0].artist);
			$(".song_title").html(data[0].title);
			$(".song_album").html(data[0].album);
			$(".song_albumart").html('<img src="' + data[0].album_art + '" />');
	
			// reset css on buttons
			$("#guessing_buttons_full .choice_1").css('opacity', '1');
			$("#guessing_buttons_full .choice_2").css('opacity', '1');
			$("#guessing_buttons_full .choice_3").css('opacity', '1');
			$("#guessing_buttons_full .choice_4").css('opacity', '1');
			
			$("#guessing_buttons_full .choice_1").removeClass("correct-selected wrong-selected");
			$("#guessing_buttons_full .choice_2").removeClass("correct-selected wrong-selected");
			$("#guessing_buttons_full .choice_3").removeClass("correct-selected wrong-selected");
			$("#guessing_buttons_full .choice_4").removeClass("correct-selected wrong-selected");
		
			artist_or_title = data[0].answerType;
			choices = data[0].wrongAnswers;
			console.log(choices);
			if( artist_or_title === 0 ){
				// add artist to array of choices
				choices.push( data[0].artist );
			} else {
				// add title to array of choices
				choices.push( data[0].title );
			}

			shuffle(choices);
			console.log( "choices: " + choices );

			for( var counter = 1; counter < 5; counter++ ){
				current_choice = choices[counter-1];
				targetElement = $("#guessing_buttons_full .choice_" + counter);
				targetElement.removeClass("wrong");
				targetElement.removeClass("correct");
				if( artist_or_title === 0 ){
					// check artist against current choice
					if( current_choice === data[0].artist ){
						targetElement.addClass("correct");
					} else {
						targetElement.addClass("wrong");
					}
				} else {
					// check title against current choice
					if( current_choice === data[0].title ){
						targetElement.addClass("correct");
					} else {
						targetElement.addClass("wrong");
					}
				}
				targetElement.html( current_choice );
			}

			// handle correct multiple choice answer
			$(".correct").click(function(){
				// let the screen know somebody got it right
				console.log("handling correct guess on controller");
				var correctGuess = [];
				correctGuess.push({ type: "correctGuess", type_of_guess: 'full'});
				air_console.message( 0 , correctGuess );
				
				// $("#guessing_buttons_full").hide();
				// grey out the other answers
				$("#guessing_buttons_full .choice_1").css('opacity', '0.2');
				$("#guessing_buttons_full .choice_2").css('opacity', '0.2');
				$("#guessing_buttons_full .choice_3").css('opacity', '0.2');
				$("#guessing_buttons_full .choice_4").css('opacity', '0.2');
				
				animatethis($('.song_title'), 3000);
				
				// wait 2 seconds, then display the correct result including link to buy the song
				sleep(2000);
							
				// fix body padding
				$("body").addClass("nomargin");
				
				// hide all guessing buttons
				$("#guessing_buttons_full").hide();
				// unhide player result area
				$("#round_over_song_details").show();
				//inform player of result
				$(".player_round_result").html("You guessed correctly!");
				
				id = $(this).attr("id");
				$("#guessing_buttons_full ." + id).css('opacity', '1');
				$("#guessing_buttons_full ." + id).addClass('correct-selected');
				
				// unnattach all event handlers so we dont start triggering multiple messages
				$(".correct").off();
				$(".wrong").off();
			});

			// handle wrong multiple choice answer
			$(".wrong").click(function(){
				// let the screen know somebody got it right
				console.log("handling wrong guess on controller");
				var wrongGuess = [];
				wrongGuess.push({ type: "wrongGuess", type_of_guess: 'full'});
				air_console.message( 0 , wrongGuess );
				
				// grey out the other answers
				$("#guessing_buttons_full .choice_1").css('opacity', '0.2');
				$("#guessing_buttons_full .choice_2").css('opacity', '0.2');
				$("#guessing_buttons_full .choice_3").css('opacity', '0.2');
				$("#guessing_buttons_full .choice_4").css('opacity', '0.2');
				
				animatethis($('.song_title'), 3000);
				
				// wait 2 seconds, then display the correct result including link to buy the song
				sleep(2000);
				
				// fix body margin
				$("body").addClass("nomargin");
				
				// hide all guessing buttons
				$("#guessing_buttons_full").hide();
				// unhide player result area
				$("#round_over_song_details").show();
				//inform player of result
				$(".player_round_result").html("You guessed wrong!");
				
				id = $(this).attr("id");
				$("#guessing_buttons_full ." + id).css('opacity', '1');
				$("#guessing_buttons_full ." + id).addClass('wrong-selected');
				
				// unnattach all event handlers so we dont start triggering multiple messages
				$(".correct").off();
				$(".wrong").off();
			});

			// display the guessing buttons
			$("#guessing_buttons_full").show();
		} 
	}
}
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
</script>

</body>