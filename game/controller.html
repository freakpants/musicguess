<head>
<script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.6.0.js"></script>
  <link rel="stylesheet" href="controller.css">
  <link rel="stylesheet" href="shared.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>
	
<body>

<div id="guessing_methods">
	<div class="instruction">Choose your guessing method to start:</div>
	<div id="guessing_method_letter" class="odd">Letter By Letter (Artist & Title)</div>
	<div id="guessing_method_full"  class="even">Full Artist or Title</div>
</div>

<div id="guessing_buttons_letter">
	<div class="choice_1" id="choice_1"></div>
	<div class="choice_2" id="choice_2"></div>
	<div class="choice_3" id="choice_3"></div>
	<div class="choice_4" id="choice_4"></div>
	
	<div class="choice_3" id="choice_5"></div>
	<div class="choice_4" id="choice_6"></div>
	<div class="choice_1" id="choice_7"></div>
	<div class="choice_2" id="choice_8"></div>
	
	<div class="choice_2" id="choice_9"></div>
	<div class="choice_1" id="choice_10"></div>
	<div class="choice_4" id="choice_11"></div>
	<div class="choice_3" id="choice_12"></div>
	
	<div class="choice_4" id="choice_13"></div>
	<div class="choice_3" id="choice_14"></div>
	<div class="choice_D" id="choice_D">Debug</div>
	<div class="choice_N" id="choice_N">Next Song</div>
</div>

<div id="guessing_buttons_full">
	<div class="choice_1" id="choice_1"></div>
	<div class="choice_2" id="choice_2"></div>
	<div class="choice_3" id="choice_3"></div>
	<div class="choice_4" id="choice_4"></div>
</div>

<script type="text/javascript">
var air_console = new AirConsole();

// globally tracks whether or not the player has one or more letters on the artist
document.on_artist_track = 0;
document.artist_track_word = '';
// globally tracks whether or not the player has one or more letters on the title
document.on_title_track = 0;
document.title_track_word = '';

// array of all reasonable characters
var alphabet = [ 'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','1','2','3','4','5','6','7','8','9','0' ];

function randomIntFromInterval( min, max ){
	return Math.floor( Math.random() * ( max - min + 1 ) + min );
}

/**
 * Shuffles array in place.
 * @param {Array} a items The array containing the items.
 */
function shuffle(a) {
    var j, x, i;
    for (i = a.length; i; i--) {
        j = Math.floor(Math.random() * i);
        x = a[i - 1];
        a[i - 1] = a[j];
        a[j] = x;
    }
}

// mix random characters onto the grid
function mix_characters( solution , type_of_track ){
	console.log("mixing characters for solution " + solution.artist + " - " + solution.title);

	// get the values for use inside the function
	on_title_track = document.on_title_track;
	on_artist_track = document.on_artist_track;

	// remove previous click handlers or we will end up crashing the browser(s)
	$(".correctArtist").off('click');
	$(".correctTitle").off('click');
		
	remove_correct_classes();
	
	// reset both solutions
	title_solution = 0;
	artist_solution = 0;

	if ( typeof type_of_track === 'undefined' ){
		// determine where to put each correct letter
		title_solution = Math.floor(Math.random() * 14  + 1);
		artist_solution = Math.floor(Math.random() * 14  + 1);
		// make sure the two solutions have different spaces
		while( artist_solution === title_solution ){
			artist_solution = Math.floor(Math.random() * 14 + 1);
		}
	} else {
		// check to see which path we are on to make sure we mix in the correct next character
		if( type_of_track === 'title' ){
			title_solution = Math.floor(Math.random() * 14 + 1);

		} else if ( type_of_track === 'artist' ){
			artist_solution = Math.floor(Math.random() * 14 + 1);
		}
	}
	console.log("progress on title track: " + on_title_track);
	if( type_of_track === 'title' ){
		console.log("putting correct letter " + solution.title[on_title_track] + " for title in " + title_solution);
	} else if ( type_of_track === 'artist' ){
		console.log("putting correct letter " + solution.artist[on_artist_track] + " for artist in " + title_solution);
	}

	
	for( var counter = 1; counter < 15; counter++ ){
		if( counter === title_solution ){
			$("#choice_" + counter).html(solution.title[on_title_track]);
			$("#choice_" + counter).addClass("correctTitle");
		} else if ( counter === artist_solution ){
			$("#choice_" + counter).html(solution.artist[on_artist_track]);
			$("#choice_" + counter).addClass("correctArtist");
		} else {
			// do it randomly
			letterIndex = Math.floor(Math.random() * alphabet.length );
			$("#choice_" + counter).html(alphabet[letterIndex]);
			// if the randomly added letter is also correct, also add the class
			if( alphabet[letterIndex] === solution.title[on_title_track]){
				$("#choice_" + counter).addClass("correctTitle");
				console.log("adding correct class to " + counter)
			}
			if( alphabet[letterIndex] === solution.artist[on_artist_track]){
				$("#choice_" + counter).addClass("correctArtist");
			}
		}
	}

	// handle clicking on a correct characters - this is done after generating the letters
	$(".correctTitle").click(function(){
		document.on_title_track++;
		// get it for use inside the click handler
		on_title_track = document.on_title_track; 
		
		// increase word that will be displayed on the screen
		document.title_track_word = document.title_track_word + solution.title[on_title_track-1];
		// let the screen know somebody got a character right
		var correctGuess = [];
		correctGuess.push({ type: "correctGuess", type_of_guess: 'title' ,  progress: on_title_track, word: document.title_track_word });
		air_console.message( 0 , correctGuess );
		
		// track starts at 0
		if ( solution.title.length === on_title_track ){
			// player guessed the title completely
			// check if he also guessed the artist
			if ( on_artist_track === 'guessed' ){
				console.log("Player guessed both artist and title!");
			} else {
				// otherwise, switch him to the artist track
				console.log("Player guessed title!")
				document.on_artist_track = 0;
				document.artist_track_word = '';
				document.on_title_track = "guessed";
				mix_characters( solution , 'artist' );
			}
		} else {
			// prepare next characters
			mix_characters( solution , 'title' );
		}
	});
	$(".correctArtist").click(function(){
		document.on_artist_track++;
		// get it for use inside the click handler
		on_artist_track = document.on_artist_track
		
		// increase word that will be displayed on the screen
		document.artist_track_word = document.artist_track_word + solution.artist[on_artist_track-1];
		// let the screen know somebody got a character right
		var correctGuess = [];
		correctGuess.push({ type: "correctGuess", type_of_guess: 'artist' ,  progress: on_artist_track, word: document.artist_track_word });
		air_console.message( 0 , correctGuess );

		// track starts at 0
		if ( solution.artist.length === on_artist_track ){
			// player guessed the artist completely
			// check if he also guessed the title
			if ( on_title_track === 'guessed' ){
				console.log("Player guessed both artist and title!");
			} else {
				// otherwise, switch him to the title track
				console.log("Player guessed artist!")
				document.on_title_track = 0;
				document.title_track_word = '';
				document.on_artist_track = "guessed";
				mix_characters( solution , 'title' );
			}
		} else {
			// prepare next characters
			mix_characters( solution , 'artist' );
		}
	});
}

function remove_correct_classes(){
	$(".correctArtist").removeClass("correctArtist");
	$(".correctTitle").removeClass("correctTitle");
}

$("#guessing_method_letter").click(function( event ){
	// instruct the screen to start the game in letter by letter mode
	var command = [];
	command.push({ type: "guessMethodLetter" });
	air_console.message( 0 , command );
});

$("#guessing_method_full").click(function( event ){
	// instruct the screen to start the game in full word mode
	var command = [];
	command.push({ type: "guessMethodFull" });
	air_console.message( 0 , command );
});

$("#choice_N").click(function( event ){
	// play next song
	var command = [];
	command.push({ type: "nextSong" });
	air_console.message( 0 , command );
});

$("#choice_D").click(function( event ){
	// turn debug on/off
	var command = [];
	command.push({ type: "debug" });
	air_console.message( 0 , command );
});



// Listen for messages from other devices
air_console.onMessage = function(from, data) {
	// analyze data
	if ( data[0].type === "solution" ){
		// hide the guessing type selection
		$("#guessing_methods").hide();
		console.log('received solution');
		if( data[0].guessingMethod === 'full' ){
			// 50:50 chance that correct answer is either artist or title
			artist_or_title = randomIntFromInterval( 0, 1 );
			choices = data[0].wrongAnswers;
			console.log(choices);
			if( artist_or_title === 0 ){
				// add artist to array of choices
				choices.push( data[0].artist );
			} else {
				// add title to array of choices
				choices.push( data[0].title );
			}

			shuffle(choices);
			console.log( "choices: " + choices );

			for( var counter = 1; counter < 5; counter++ ){
				current_choice = choices[counter-1];
				targetElement = $("#guessing_buttons_full .choice_" + counter);
				targetElement.removeClass("wrong");
				targetElement.removeClass("correct");
				if( artist_or_title === 0 ){
					// check artist against current choice
					if( current_choice === data[0].artist ){
						targetElement.addClass("correct");
					} else {
						targetElement.addClass("wrong");
					}
				} else {
					// check title against current choice
					if( current_choice === data[0].title ){
						targetElement.addClass("correct");
					} else {
						targetElement.addClass("wrong");
					}
				}
				targetElement.html( current_choice );
			}

			// handle correct multiple choice answer
			$(".correct").click(function(){
				// let the screen know somebody got it right
				console.log("handling correct guess on controller");
				var correctGuess = [];
				correctGuess.push({ type: "correctGuess", type_of_guess: 'full'});
				air_console.message( 0 , correctGuess );
				$("#guessing_buttons_full").hide();
				// unnattach all event handlers so we dont start triggering multiple messages
				$(".correct").off();
				$(".wrong").off();
			});

			// handle wrong multiple choice answer
			$(".wrong").click(function(){
				// let the screen know somebody got it right
				console.log("handling wrong guess on controller");
				var wrongGuess = [];
				wrongGuess.push({ type: "wrongGuess", type_of_guess: 'full'});
				air_console.message( 0 , wrongGuess );
				$("#guessing_buttons_full").hide();
				// unnattach all event handlers so we dont start triggering multiple messages
				$(".correct").off();
				$(".wrong").off();
			});

			// display the guessing buttons
			$("#guessing_buttons_full").show();
		} else {
			// reset progress
			document.on_artist_track = 0;
			document.artist_track_word = '';
			document.on_title_track = 0;
			document.title_track_word = '';
			// mix the characters a first time, including the first letter of each solution
			mix_characters( data[0] );
			
			// display the guessing buttons
			$("#guessing_buttons_letter").show();
		}
	}
}
</script>

</body>